name: Provider Smoke Tests

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:

jobs:
  smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install --frozen-lockfile
      - name: Run smoke tests
        run: bun test src/tests/e2e --timeout 120000
        continue-on-error: true
        id: smoke
        env:
          HENTEPLAN_API_KEY: ${{ secrets.HENTEPLAN_API_KEY }}
      - name: Create issue on failure
        if: steps.smoke.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const existing = await github.rest.issues.listForRepo({
              owner: context.repo.owner, repo: context.repo.repo,
              state: 'open', labels: 'provider-alert', per_page: 5
            });
            if (!existing.data.some(i => i.title.startsWith('Provider smoke test'))) {
              await github.rest.issues.create({
                owner: context.repo.owner, repo: context.repo.repo,
                title: `Provider smoke test failure â€” ${new Date().toISOString().slice(0, 10)}`,
                body: `Daily smoke tests failed.\n\n[Workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
                labels: ['provider-alert']
              });
            }
      - name: Fail workflow
        if: steps.smoke.outcome == 'failure'
        run: exit 1
